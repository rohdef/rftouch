// Generated by CoffeeScript 1.3.3

buster.testCase("ReloadStore", {
  setUp: function() {
    var proxyName;
    proxyName = 'RfTouchTest.data.proxy.FailProxy';
    Ext.syncRequire(proxyName);
    this.testFailProxy = Ext.create(proxyName);
    return this.reloadStore = Ext.create('RfTouch.data.ReloadStore', {
      model: 'RfTouchTest.model.Person',
      proxy: this.testFailProxy
    });
  },
  "ReloadStore can succeed in first try": function(done) {
    this.testFailProxy.setFailCount(0);
    this.reloadStore.on('load', function(store, records, successful, operation, opts) {
      expect(successful).toEqual(true);
      return done();
    });
    return this.reloadStore.load();
  },
  "Bailout event is fired after 3 tries": function(done) {
    var tries;
    tries = 0;
    this.reloadStore.on('load', function(store, records, successful, operation, opts) {
      return tries += 1;
    });
    this.reloadStore.on('bailout', function(store) {
      expect(tries).toEqual(3);
      return done();
    });
    return this.reloadStore.load();
  },
  "Retrying on bailout will cause 3 new retries": function(done) {
    var tries;
    tries = 0;
    this.testFailProxy.setFailCount(6);
    this.reloadStore.on('load', function(store, records, successful, operation, opts) {
      return tries += 1;
    });
    this.reloadStore.on('bailout', function(store) {
      if (tries === 3) {
        return store.resetAndReload();
      } else {
        expect(tries).toEqual(6);
        return done();
      }
    });
    return this.reloadStore.load();
  },
  "Store succeeds after 2 reload when failproxy is set to fail twice": function(done) {
    var tries;
    tries = 0;
    this.testFailProxy.setFailCount(2);
    this.reloadStore.on('load', function(store, records, successful, operation, opts) {
      tries += 1;
      if (tries === 3) {
        expect(successful).toEqual(true);
        return done();
      }
    });
    return this.reloadStore.load();
  },
  "Store succeeds when retrying on bailout": function(done) {
    var tries;
    tries = 0;
    this.reloadStore.on('load', function(store, records, successful, operation, opts) {
      tries += 1;
      if (tries === 4) {
        expect(successful).toEqual(true);
        return done();
      }
    });
    this.reloadStore.on('bailout', function(store) {
      return store.load();
    });
    return this.reloadStore.load();
  },
  "Bailout event is fired every time when retries is set to 0": function(done) {
    var bailouts, tries;
    tries = 0;
    bailouts = 0;
    this.testFailProxy.setFailCount(5);
    this.reloadStore.setRetries(0);
    this.reloadStore.on('load', function(store, records, successful, operation, opts) {
      return tries += 1;
    });
    this.reloadStore.on('bailout', function(store) {
      bailouts += 1;
      if (bailouts === 4) {
        expect(tries).toEqual(4);
        return done();
      } else {
        return store.resetAndReload();
      }
    });
    return this.reloadStore.load();
  }
});
